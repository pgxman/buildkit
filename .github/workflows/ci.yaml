name: CI
on:
  push:
    branches:
      - main
  pull_request:
  workflow_call:
  workflow_dispatch:
jobs:
  detect_changed_extensions:
    name: Detect changed extensions
    runs-on: ubuntu-latest
    outputs:
      changed_extensions: ${{ steps.detect-changed-files.outputs.changed_extensions }}
    steps:
      - uses: actions/checkout@v3
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v37
        with:
          files: |
            buildkit/*.yaml
            .github/workflows/**
            script/**
      - id: detect-changed-files
        run: |
          changed_extensions=$(script/changed-extensions ${{ steps.changed-files.outputs.all_changed_files }})
          echo "$changed_extensions"
          echo "changed_extensions=$changed_extensions" >> "$GITHUB_OUTPUT"
  build:
    name: Build Extensions
    needs: [detect_changed_extensions]
    uses: ./.github/workflows/build.yaml
    with:
      extensions: ${{ needs.detect_changed_extensions.outputs.changed_extensions }}
    secrets: inherit
  publish:
    name: Publish Extensions
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: 3.2.2
      - uses: actions/checkout@v3
        with:
          repository: deb-s3/deb-s3
          ref: ee4fb051073a8387c9d3d5275a41194b62942c83
      - name: Install deb-s3
        run: |
          gem build
          gem install deb-s3-0.11.7.gem
      - name: Import GPG Key
        env:
          GPG_PRIVATE: ${{ secrets.GPG_PRIVATE }}
          GPG_PUBLIC: ${{ secrets.GPG_PUBLIC }}
        run: |
          echo -e "$GPG_PRIVATE" | gpg --import --no-tty --batch --yes
          echo -e "$GPG_PUBLIC" | gpg --import --no-tty --batch --yes
          echo "allow-preset-passphrase" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent RELOADAGENT /bye
      - name: Download Artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      - name: Publish Artifacts
        env:
          AWS_DEBIAN_S3_BUCKET: ${{ secrets.AWS_DEBIAN_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GPG_SIGNING_KEY_ID: C9ADBB93237BCD3B
        run: |
          tree ./artifacts
          deb-s3 upload \
            --lock \
            --bucket $AWS_DEBIAN_S3_BUCKET \
            --visibility public \
            --sign $GPG_SIGNING_KEY_ID \
            ./artifacts/**/*.deb
